<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affitto o Viaggio? - Calcolatore Nazionale</title>
    <meta name="description" content="Calcolatore pendolari con copertura di tutte le province italiane.">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- STILI BASE --- */
        :root {
            --primary: #2563eb; --primary-dark: #1e40af;
            --secondary: #10b981; --danger: #ef4444;
            --bg-right: #f8fafc; --card-bg: #ffffff;
            --text-main: #1f2937; --text-muted: #6b7280;
            --input-bg: #ffffff; --input-border: #e2e8f0;
            --highlight-bg: #eff6ff; --highlight-border: #bfdbfe;
        }

        [data-theme="dark"] {
            --primary: #3b82f6; --primary-dark: #60a5fa;
            --bg-right: #0f172a; --card-bg: #1e293b;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
            --input-bg: #334155; --input-border: #475569;
            --highlight-bg: #1e3a8a; --highlight-border: #1e40af;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            min-height: 100vh; display: flex; overflow-x: hidden; 
            background-color: var(--bg-right); color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .image-side {
            flex: 1; 
            background-image: url('https://images.unsplash.com/photo-1474487548417-781cb714c2f0?q=80&w=2600&auto=format&fit=crop'); 
            background-size: cover; background-position: center; position: relative;
        }
        .image-side::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom right, rgba(30, 64, 175, 0.4), rgba(0, 0, 0, 0.7));
        }
        .image-content { 
            position: absolute; top: 50%; transform: translateY(-50%); 
            left: 50px; right: 50px; color: white; z-index: 2; 
        }
        .image-content h2 { font-size: 2.8rem; margin: 0 0 15px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.5); line-height: 1.2; }
        .image-content p { font-size: 1.3rem; opacity: 0.95; line-height: 1.5; }
        
        .form-side {
            flex: 1; background-color: var(--bg-right);
            display: flex; justify-content: center; align-items: center; 
            padding: 40px 20px; transition: background-color 0.3s;
        }
        .container {
            background-color: var(--card-bg); padding: 2.5rem; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.08); width: 100%; max-width: 500px; 
            transition: background-color 0.3s;
        }
        
        .header-section { text-align: center; margin-bottom: 1.5rem; position: relative; }
        h1 { color: var(--text-main); margin-top: 0; font-size: 1.8rem; margin-bottom: 5px; display: inline-block; }
        p.subtitle { color: var(--text-muted); margin: 0; }
        
        .header-controls { position: absolute; top: 0; right: 0; display: flex; gap: 10px; }
        .icon-btn {
            background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted);
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-size: 1.2rem;
            transition: all 0.2s;
        }
        .icon-btn:hover { background: var(--highlight-bg); color: var(--primary); border-color: var(--primary); }
        .logout-btn { display: none; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 9999; display: none; 
            justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background: var(--card-bg); padding: 2rem; border-radius: 20px;
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideUp 0.4s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-input { 
            width: 100%; padding: 15px; border: 2px solid var(--input-border); background: var(--input-bg); color: var(--text-main);
            border-radius: 12px; font-size: 1.1rem; margin: 20px 0; text-align: center; 
        }
        
        .highlight-box { background: var(--highlight-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--highlight-border); margin-bottom: 20px; }
        .input-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.4rem; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .hint { font-size: 0.8rem; color: var(--text-muted); font-weight: normal; }
        input, select { 
            width: 100%; padding: 12px; border: 2px solid var(--input-border); 
            border-radius: 8px; font-size: 0.95rem; 
            background-color: var(--input-bg); color: var(--text-main);
        }
        
        button.main-btn { width: 100%; padding: 16px; background-color: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 10px; font-size: 1.1rem; transition: background 0.3s; }
        button.main-btn:hover { background-color: var(--primary-dark); }
        
        #results { margin-top: 2rem; padding-top: 1rem; border-top: 2px dashed var(--input-border); display: none; }
        .verdict { font-weight: bold; text-align: center; margin-bottom: 1rem; padding: 15px; border-radius: 8px; font-size: 1.1rem; color: #1f2937; }
        .bar-container { height: 20px; background-color: var(--input-border); border-radius: 20px; margin-bottom: 10px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 1s; }
        .bar-label { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; color: var(--text-main); }
        
        .action-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .action-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px; 
            font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            color: white; transition: transform 0.2s;
        }
        .action-btn:active { transform: scale(0.98); }
        .btn-pdf { background-color: #64748b; }
        .btn-whatsapp { background-color: #25D366; }

        .history-section { margin-top: 30px; border-top: 2px solid var(--input-border); padding-top: 20px; }
        .history-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; color: var(--text-main); }
        .history-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
        .history-item {
            background: var(--input-bg); border: 1px solid var(--input-border); padding: 10px;
            border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem;
            display: flex; justify-content: space-between; align-items: center; color: var(--text-main);
        }
        .history-badge { padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .badge-city { background: #fecaca; color: #991b1b; }
        .badge-travel { background: #d1fae5; color: #065f46; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; background: var(--text-muted); width: auto; margin: 0; color: white; border:none; border-radius:6px; cursor:pointer;}

        @media (max-width: 900px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            .image-side { display: none; } 
            .form-side { padding: 20px 15px; }
            .container { padding: 1.5rem; }
            .header-controls { position: relative; justify-content: center; margin-bottom: 10px; top: auto; right: auto;}
        }
    </style>
</head>
<body>

<div id="welcomeModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-icon">üëã</span>
        <h2 style="margin:0; color:#1f2937;">Benvenuto!</h2>
        <p style="color:#6b7280; margin-top:10px;">Come ti chiami? Personalizzeremo i calcoli.</p>
        <input type="text" id="modalNameInput" class="modal-input" placeholder="Il tuo nome...">
        <button class="main-btn" onclick="saveNameFromModal()">Inizia</button>
        <span class="modal-skip" onclick="closeModal()">Salta per ora</span>
        <div id="privacyText" style="font-size: 0.75rem; color: #64748b; margin-top: 20px; background: #f1f5f9; padding: 8px; border-radius: 6px;">
            üîí Verifica dispositivo...
        </div>
    </div>
</div>

<div class="image-side">
    <div class="image-content">
        <h2>Studente o Lavoratore?</h2>
        <p>Il tempo √® l'unica risorsa che non puoi guadagnare. Scopri quanto ti costa davvero fare il pendolare.</p>
    </div>
</div>

<div class="form-side">
    <div class="container" id="mainContainer">
        <div class="header-section">
            <div class="header-controls">
                <button class="icon-btn" onclick="toggleTheme()" title="Cambia Tema">üåì</button>
                <button id="logoutBtn" class="icon-btn logout-btn" onclick="logoutUser()" title="Esci">‚ùå</button>
            </div>
            <h1 id="pageTitle">üè† Citt√† vs. Pendolare üöÜ</h1>
            <p class="subtitle" id="pageSubtitle">Calcola risparmio in 30 secondi.</p>
        </div>

        <div class="highlight-box">
            <div class="input-group">
                <label>üë§ Chi sei?</label>
                <select id="userType" onchange="updateProfile()">
                    <option value="worker" selected>Lavoratore Full-Time</option>
                    <option value="student">Studente Universitario</option>
                    <option value="part">Lavoratore Part-Time</option>
                    <option value="occasional">Viaggiatore Weekend</option>
                    <option value="unemployed">In cerca di lavoro</option>
                </select>
            </div>
            <div class="input-group" style="margin-bottom: 0;">
                <label>üìÖ Giorni di viaggio al mese</label>
                <input type="number" id="daysPerMonth" value="20">
            </div>
        </div>

        <div class="input-group">
            <label>üìç Dove lavori/studi?</label>
            <select id="workCity" onchange="loadOrigins()">
                <option value="" disabled selected>-- Seleziona Citt√† Hub --</option>
                <option value="milano">Milano (Lombardia)</option>
                <option value="roma">Roma (Lazio)</option>
                <option value="bologna">Bologna (Emilia)</option>
                <option value="torino">Torino (Piemonte)</option>
                <option value="napoli">Napoli (Campania)</option>
                <option value="firenze">Firenze (Toscana)</option>
                <option value="venezia">Venezia (Veneto)</option>
                <option value="genova">Genova (Liguria)</option>
                <option value="bari">Bari (Puglia)</option>
            </select>
        </div>

        <div class="input-group">
            <label>üè† Da dove parti?</label>
            <select id="homeCity" onchange="fillData()" disabled>
                <option value="">-- Scegli prima la destinazione --</option>
            </select>
        </div>
        
        <hr style="border: 0; border-top: 1px solid var(--input-border); margin: 20px 0;">

        <div class="input-group"><label>üè¢ Affitto Destinazione (‚Ç¨)</label><input type="number" id="rentCity"></div>
        <div class="input-group"><label>üè° Affitto Partenza (‚Ç¨)</label><input type="number" id="rentHome"></div>
        <div class="input-group"><label>üé´ Costo Viaggio (‚Ç¨)</label><input type="number" id="transportCost"></div>
        <div class="input-group"><label>‚è±Ô∏è Minuti A/R</label><input type="number" id="travelTime"></div>
        <div class="input-group"><label>üíé Valore orario (‚Ç¨)</label><input type="number" id="hourlyValue" value="10"></div>

        <button class="main-btn" onclick="calculate()">Calcola e Salva</button>

        <div id="results">
            <div class="verdict" id="verdictText"></div>
            <div class="bar-label"><span>Vivere l√¨</span> <span id="valCity">0‚Ç¨</span></div>
            <div class="bar-container"><div class="bar-fill" id="barCity" style="width:0%; background:var(--primary)"></div></div>
            <div class="bar-label"><span>Viaggiare</span> <span id="valHome">0‚Ç¨</span></div>
            <div class="bar-container"><div class="bar-fill" id="barHome" style="width:0%; background:var(--secondary)"></div></div>

            <div class="action-buttons" data-html2canvas-ignore="true">
                <button class="action-btn btn-whatsapp" onclick="shareWhatsapp()"><span>üí¨</span> WhatsApp</button>
                <button class="action-btn btn-pdf" onclick="generatePDF()"><span>üìÑ</span> PDF</button>
            </div>
        </div>

        <div class="history-section" data-html2canvas-ignore="true">
            <div class="history-title">
                üïí Cronologia
                <button class="btn-small" onclick="clearHistory()">Pulisci</button>
            </div>
            <ul id="historyList" class="history-list">
                <li style="color:var(--text-muted); text-align:center; padding:10px;">Nessun calcolo recente.</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // --- GESTIONE APP ---
    function toggleTheme() {
        const body = document.body;
        const current = body.getAttribute("data-theme");
        if (current === "dark") { body.removeAttribute("data-theme"); localStorage.setItem("theme", "light"); }
        else { body.setAttribute("data-theme", "dark"); localStorage.setItem("theme", "dark"); }
    }

    window.onload = function() {
        if (localStorage.getItem("theme") === "dark") document.body.setAttribute("data-theme", "dark");
        
        const privacyText = document.getElementById('privacyText');
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
        privacyText.innerHTML = isMobile ? "üîí Sicuro: Dati salvati su questo Telefono." : "üîí Sicuro: Dati salvati su questo PC.";

        const storedName = localStorage.getItem('userName');
        if (!storedName) { document.getElementById('welcomeModal').style.display = 'flex'; }
        else { personalizeUI(storedName); }
        loadHistory(); 
    };

    function saveNameFromModal() {
        const name = document.getElementById('modalNameInput').value;
        if (name.trim()) { localStorage.setItem('userName', name); personalizeUI(name); closeModal(); }
        else { alert("Inserisci un nome."); }
    }
    function closeModal() { document.getElementById('welcomeModal').style.display = 'none'; }
    function personalizeUI(name) {
        document.getElementById('pageTitle').innerText = "Ciao, " + name + "! üëã";
        document.getElementById('logoutBtn').style.display = "flex";
    }
    function logoutUser() {
        if(confirm("Vuoi uscire?")) { localStorage.removeItem('userName'); localStorage.removeItem('calcHistory'); location.reload(); }
    }

    // --- MEGA DATABASE PROVINCE ITALIANE (Stime 2025) ---
    // Struttura: Hub -> Province Collegate
    const routes = {
        milano: {
            rent: 1350,
            origins: {
                varese: { name: "Varese", cost: 75, time: 110, rent: 700 },
                como: { name: "Como", cost: 70, time: 90, rent: 750 },
                lecco: { name: "Lecco", cost: 70, time: 100, rent: 650 },
                sondrio: { name: "Sondrio", cost: 95, time: 240, rent: 550 },
                bergamo: { name: "Bergamo", cost: 65, time: 100, rent: 700 },
                brescia: { name: "Brescia", cost: 105, time: 120, rent: 650 },
                pavia: { name: "Pavia", cost: 60, time: 70, rent: 650 },
                lodi: { name: "Lodi", cost: 55, time: 60, rent: 650 },
                cremona: { name: "Cremona", cost: 85, time: 130, rent: 550 },
                mantova: { name: "Mantova", cost: 95, time: 240, rent: 500 },
                monza: { name: "Monza", cost: 40, time: 30, rent: 850 },
                novara: { name: "Novara (PIE)", cost: 75, time: 90, rent: 600 },
                piacenza: { name: "Piacenza (EMI)", cost: 85, time: 100, rent: 550 }
            }
        },
        roma: {
            rent: 1150,
            origins: {
                viterbo: { name: "Viterbo", cost: 70, time: 160, rent: 500 },
                rieti: { name: "Rieti", cost: 65, time: 180, rent: 450 },
                latina: { name: "Latina", cost: 60, time: 90, rent: 600 },
                frosinone: { name: "Frosinone", cost: 75, time: 130, rent: 500 },
                civitavecchia: { name: "Civitavecchia (RM)", cost: 70, time: 110, rent: 650 },
                tivoli: { name: "Tivoli (RM)", cost: 45, time: 70, rent: 600 },
                guidonia: { name: "Guidonia (RM)", cost: 45, time: 60, rent: 550 },
                anzio: { name: "Anzio/Nettuno (RM)", cost: 55, time: 140, rent: 550 }
            }
        },
        bologna: {
            rent: 950,
            origins: {
                modena: { name: "Modena", cost: 55, time: 60, rent: 700 },
                reggio: { name: "Reggio Emilia", cost: 65, time: 90, rent: 600 },
                parma: { name: "Parma", cost: 75, time: 110, rent: 600 },
                piacenza: { name: "Piacenza", cost: 90, time: 150, rent: 550 },
                ferrara: { name: "Ferrara", cost: 60, time: 70, rent: 600 },
                ravenna: { name: "Ravenna", cost: 80, time: 140, rent: 550 },
                forli: { name: "Forl√¨-Cesena", cost: 70, time: 90, rent: 500 },
                rimini: { name: "Rimini", cost: 110, time: 130, rent: 650 }
            }
        },
        torino: {
            rent: 800,
            origins: {
                cuneo: { name: "Cuneo", cost: 80, time: 140, rent: 500 },
                asti: { name: "Asti", cost: 70, time: 80, rent: 500 },
                alessandria: { name: "Alessandria", cost: 85, time: 110, rent: 450 },
                biella: { name: "Biella", cost: 80, time: 140, rent: 450 },
                novara: { name: "Novara", cost: 85, time: 100, rent: 600 },
                vercelli: { name: "Vercelli", cost: 75, time: 100, rent: 450 },
                verbania: { name: "Verbania (VCO)", cost: 90, time: 180, rent: 550 },
                ivrea: { name: "Ivrea (TO)", cost: 65, time: 100, rent: 500 }
            }
        },
        napoli: {
            rent: 900,
            origins: {
                caserta: { name: "Caserta", cost: 50, time: 60, rent: 550 },
                benevento: { name: "Benevento", cost: 75, time: 180, rent: 500 },
                avellino: { name: "Avellino", cost: 65, time: 120, rent: 500 },
                salerno: { name: "Salerno", cost: 65, time: 90, rent: 650 }
            }
        },
        firenze: {
            rent: 1000,
            origins: {
                prato: { name: "Prato", cost: 40, time: 40, rent: 700 },
                pistoia: { name: "Pistoia", cost: 55, time: 70, rent: 650 },
                lucca: { name: "Lucca", cost: 75, time: 100, rent: 600 },
                pisa: { name: "Pisa", cost: 80, time: 120, rent: 700 },
                livorno: { name: "Livorno", cost: 90, time: 140, rent: 650 },
                siena: { name: "Siena", cost: 90, time: 180, rent: 650 },
                arezzo: { name: "Arezzo", cost: 85, time: 100, rent: 600 }
            }
        },
        venezia: {
            rent: 900,
            origins: {
                treviso: { name: "Treviso", cost: 55, time: 60, rent: 650 },
                padova: { name: "Padova", cost: 55, time: 50, rent: 650 },
                vicenza: { name: "Vicenza", cost: 70, time: 90, rent: 600 },
                verona: { name: "Verona", cost: 95, time: 140, rent: 700 },
                rovigo: { name: "Rovigo", cost: 75, time: 100, rent: 500 }
            }
        },
        genova: {
            rent: 750,
            origins: {
                savona: { name: "Savona", cost: 65, time: 90, rent: 600 },
                imperia: { name: "Imperia", cost: 95, time: 180, rent: 650 },
                spezia: { name: "La Spezia", cost: 95, time: 160, rent: 600 },
                alessandria: { name: "Alessandria (PIE)", cost: 80, time: 100, rent: 450 }
            }
        },
        bari: {
            rent: 700,
            origins: {
                foggia: { name: "Foggia", cost: 90, time: 160, rent: 450 },
                bat: { name: "Barletta-Andria-Trani", cost: 60, time: 80, rent: 500 },
                brindisi: { name: "Brindisi", cost: 85, time: 120, rent: 500 },
                lecce: { name: "Lecce", cost: 100, time: 180, rent: 550 },
                taranto: { name: "Taranto", cost: 90, time: 160, rent: 450 }
            }
        }
    };

    function updateProfile() {
        const t = document.getElementById('userType').value;
        const d = document.getElementById('daysPerMonth');
        const h = document.getElementById('hourlyValue');
        if(t==='worker'){d.value=20;h.value=15;} else if(t==='student'){d.value=16;h.value=0;} else if(t==='part'){d.value=12;h.value=12;} else if(t==='occasional'){d.value=4;h.value=0;} else {d.value=10;h.value=0;}
    }

    function loadOrigins() {
        const w = document.getElementById('workCity').value;
        const h = document.getElementById('homeCity');
        const r = document.getElementById('rentCity');
        h.innerHTML = '<option value="" disabled selected>-- Scegli partenza --</option>'; h.disabled = false;
        if(routes[w]) { r.value = routes[w].rent; for (let k in routes[w].origins) { let o=document.createElement("option"); o.value=k; o.text=routes[w].origins[k].name; h.add(o); } }
    }

    function fillData() {
        const w=document.getElementById('workCity').value, hk=document.getElementById('homeCity').value;
        if(w && hk && routes[w].origins[hk]){ const d=routes[w].origins[hk]; document.getElementById('rentHome').value=d.rent; document.getElementById('transportCost').value=d.cost; document.getElementById('travelTime').value=d.time; }
    }

    let lastSaving = 0, lastWinner = "";

    function calculate() {
        const rC = parseFloat(document.getElementById('rentCity').value)||0;
        const rH = parseFloat(document.getElementById('rentHome').value)||0;
        const trC = parseFloat(document.getElementById('transportCost').value)||0;
        const tM = parseFloat(document.getElementById('travelTime').value)||0;
        const hV = parseFloat(document.getElementById('hourlyValue').value)||0;
        const days = parseFloat(document.getElementById('daysPerMonth').value)||0;

        const timeCost = (tM / 60) * days * hV;
        const totCity = rC;
        const totHome = rH + trC + timeCost;
        
        const res = document.getElementById('results');
        const verd = document.getElementById('verdictText');
        res.style.display = 'block';
        
        const fmt = n => n.toLocaleString('it-IT', {style:'currency', currency:'EUR', maximumFractionDigits:0});
        document.getElementById('valCity').innerText = fmt(totCity);
        document.getElementById('valHome').innerText = fmt(totHome);
        
        const max = Math.max(totCity, totHome);
        document.getElementById('barCity').style.width = (totCity/max*100)+'%';
        document.getElementById('barHome').style.width = (totHome/max*100)+'%';

        lastSaving = Math.abs(totCity - totHome);
        if (totHome > totCity) {
            verd.innerHTML = `üõë Resta in Citt√†.<br>Perdi ${fmt(lastSaving)}`;
            verd.style.backgroundColor = "#fef2f2"; verd.style.color = "#ef4444";
            lastWinner = "Citt√†";
        } else {
            verd.innerHTML = `‚úÖ Viaggia.<br>Risparmi ${fmt(lastSaving)}`;
            verd.style.backgroundColor = "#ecfdf5"; verd.style.color = "#10b981";
            lastWinner = "Viaggio";
        }
        res.scrollIntoView({behavior: 'smooth'});
        saveToHistory(lastWinner, lastSaving);
    }

    function generatePDF() {
        const element = document.getElementById('mainContainer');
        const userName = localStorage.getItem('userName') || "Utente";
        html2pdf().set({ margin:0.5, filename:'Report_'+userName+'.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'letter',orientation:'portrait'} }).from(element).save();
    }

    function shareWhatsapp() {
        const text = `Ho appena calcolato che con "${lastWinner}" risparmio ${lastSaving}‚Ç¨! üò± Calcola anche tu: ${window.location.href}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    }

    function saveToHistory(winner, saving) {
        let history = JSON.parse(localStorage.getItem('calcHistory')) || [];
        const citySelect = document.getElementById('workCity');
        const cityName = citySelect.options[citySelect.selectedIndex].text.split(' ')[0] || "Calcolo";
        history.unshift({ date: new Date().toLocaleDateString(), city: cityName, winner: winner, amount: Math.round(saving) });
        if(history.length > 5) history.pop();
        localStorage.setItem('calcHistory', JSON.stringify(history));
        loadHistory();
    }

    function loadHistory() {
        const list = document.getElementById('historyList');
        let history = JSON.parse(localStorage.getItem('calcHistory')) || [];
        list.innerHTML = "";
        if(history.length === 0) { list.innerHTML = "<li style='color:var(--text-muted); text-align:center; padding:10px;'>Nessun calcolo recente.</li>"; return; }
        history.forEach(item => {
            let badgeClass = item.winner === "Citt√†" ? "badge-city" : "badge-travel";
            list.innerHTML += `<li class="history-item"><div><strong>${item.city}</strong> <span style="font-size:0.8em; opacity:0.7">(${item.date})</span><br>Vince: <span class="history-badge ${badgeClass}">${item.winner}</span></div><div style="font-weight:bold;">Risparmio: ${item.amount}‚Ç¨</div></li>`;
        });
    }

    function clearHistory() {
        if(confirm("Vuoi cancellare tutta la cronologia?")) { localStorage.removeItem('calcHistory'); loadHistory(); }
    }
</script>

</body>
</html>