<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pendolareApp.it | Scelte Intelligenti</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --primary: #0f172a; --accent: #2563eb; --accent-hover: #1d4ed8;
            --bg-body: #f8fafc; --bg-card: #ffffff; --bg-input: #f1f5f9;
            --text-main: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
            --chat-user: #dbeafe; --chat-bot: #f8fafc;
            --wa-color: #25D366; --wa-hover: #1ebc57;
        }
        [data-theme="dark"] {
            --primary: #f8fafc; --accent: #3b82f6; --accent-hover: #60a5fa;
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-input: #334155;
            --text-main: #f1f5f9; --text-muted: #94a3b8; --border: #334155;
            --chat-user: #1e40af; --chat-bot: #334155;
        }

        * { box-sizing: border-box; outline: none; font-family: 'Inter', sans-serif; }
        body { margin: 0; padding-top: 60px; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; background-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop'); background-size: cover; background-attachment: fixed; transition: 0.3s; }
        [data-theme="dark"] body { background-blend-mode: multiply; background-color: #0f172a; }

        /* NAVBAR & UI */
        .navbar { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); padding: 0 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
        [data-theme="dark"] .navbar { background: rgba(15,23,42,0.95); }
        .logo { font-weight: 800; font-size: 1.2rem; color: var(--accent); display: flex; align-items: center; gap: 8px; }
        .btn-icon { background: none; border: 1px solid var(--border); padding: 8px; border-radius: 8px; color: var(--text-main); cursor: pointer; }

        /* MENU LATERALE */
        .menu-overlay { position: fixed; top: 60px; left: 0; width: 100%; height: calc(100vh - 60px); background: rgba(0,0,0,0.5); z-index: 998; display: none; }
        .side-menu { position: fixed; top: 60px; left: -260px; width: 250px; height: calc(100vh - 60px); background: var(--bg-card); border-right: 1px solid var(--border); z-index: 999; transition: 0.3s; padding: 20px; display: flex; flex-direction: column; gap: 5px; }
        .side-menu.open { left: 0; }
        .menu-item { padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; gap: 12px; align-items: center; color: var(--text-main); }
        .menu-item.active { background: var(--bg-input); color: var(--accent); }
        
        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        .section-view { display: none; animation: fadeIn 0.4s; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        .card { background: var(--bg-card); border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media(max-width:700px){ .grid-2 { grid-template-columns: 1fr; } }
        
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-input); color: var(--text-main); font-weight: 500; margin-bottom: 10px; }
        .btn-main { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 10px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn-wa { background: var(--wa-color); } .btn-wa:hover { background: var(--wa-hover); }

        /* CHATBOT */
        .chat-area { height: 450px; overflow-y: auto; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; gap: 12px; margin-bottom: 10px; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; }
        .msg-bot { background: var(--chat-bot); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 4px; color: var(--text-main); }
        .msg-user { background: var(--chat-user); align-self: flex-end; border-bottom-right-radius: 4px; color: #1e3a8a; }
        .msg-img { max-width: 100%; border-radius: 10px; margin-top: 5px; border: 2px solid var(--accent); }
        .ai-tools { display: flex; gap: 8px; padding: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; align-items: center; }
        #camera-preview { width: 100%; height: 200px; background: #000; border-radius: 10px; display: none; object-fit: cover; margin-bottom: 10px; }

        /* AUTH & COMMUNITY */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--bg-card); padding: 30px; border-radius: 20px; width: 90%; max-width: 380px; text-align: center; border: 1px solid var(--border); }
        .post { border-bottom: 1px solid var(--border); padding: 15px 0; }
        .post-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .post-user { font-weight: 700; color: var(--accent); }

        /* RESULTS */
        .verdict-box { text-align: center; padding: 15px; border-radius: 12px; font-weight: 700; margin-bottom: 20px; }
        .win-green { background: rgba(16,185,129,0.15); color: #047857; border: 1px solid #10b981; }
        .win-red { background: rgba(239,68,68,0.15); color: #b91c1c; border: 1px solid #ef4444; }
        #pdf-template { position: absolute; left: -9999px; background: white; padding: 40px; width: 210mm; color: black; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <i class="fa-solid fa-train-subway" style="font-size:3rem; color:var(--accent); margin-bottom:15px;"></i>
            <h2 style="margin:0 0 10px 0;">pendolareApp.it</h2>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">Login per Community e AI.</p>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-main" onclick="login()" style="width:100%">Accedi</button>
            <button class="btn-main" style="background:transparent; border:1px solid var(--border); color:var(--text-main); margin-top:10px; width:100%" onclick="register()">Registrati</button>
            <p id="auth-error" style="color:#ef4444; font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <nav class="navbar">
        <div class="logo">
            <button class="btn-icon" onclick="toggleMenu()" style="border:none; margin-right:5px;"><i class="fa-solid fa-bars"></i></button>
            pendolareApp<span style="opacity:0.6; font-size:0.7em;">.it</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <span id="user-display" style="font-size:0.8rem; font-weight:600; display:none;">User</span>
            <button class="btn-icon" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
        </div>
    </nav>

    <div class="menu-overlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="menu-item active" onclick="nav('home')"><i class="fa-solid fa-calculator"></i> Calcolatore</div>
        <div class="menu-item" onclick="nav('ai')"><i class="fa-solid fa-robot"></i> AI Treni & Foto</div>
        <div class="menu-item" onclick="nav('community')"><i class="fa-solid fa-users"></i> Community</div>
        <div class="menu-item" onclick="nav('about')"><i class="fa-solid fa-circle-info"></i> Chi Siamo</div>
        <div style="margin-top:auto; padding-top:10px; border-top:1px solid var(--border);">
            <div class="menu-item" onclick="logout()" style="color:#ef4444;"><i class="fa-solid fa-right-from-bracket"></i> Esci</div>
        </div>
    </div>

    <div class="container">
        
        <div id="home" class="section-view active">
            <div class="grid-2">
                <div class="card">
                    <h3 style="margin-top:0;"><i class="fa-solid fa-sliders"></i> Dati Viaggio</h3>
                    <div class="grid-2">
                        <div>
                            <label>Lavoro (Capoluogo)</label>
                            <select id="hubCity" onchange="updateOrigins()"><option value="" disabled selected>-- Scegli --</option></select>
                        </div>
                        <div>
                            <label>Casa (Provincia)</label>
                            <select id="originCity" onchange="fillData()" disabled><option>-- Prima Hub --</option></select>
                        </div>
                    </div>
                    <hr style="border:0; border-top:1px dashed var(--border); margin:15px 0;">
                    <div class="grid-2">
                        <div><label>Affitto Citt√† (‚Ç¨)</label><input type="number" id="rentCity"></div>
                        <div><label>Affitto Casa (‚Ç¨)</label><input type="number" id="rentHome"></div>
                        <div><label>Costo Viaggio (‚Ç¨)</label><input type="number" id="transportCost"></div>
                        <div><label>Valore Tempo (‚Ç¨/h)</label><input type="number" id="hourlyValue" value="10"></div>
                    </div>
                    <label style="margin-top:10px;">Tempo A+R: <span id="tVal" style="color:var(--accent)">90</span> min</label>
                    <input type="range" id="travelTime" min="0" max="300" step="5" value="90" oninput="document.getElementById('tVal').innerText=this.value">
                    <div style="background:var(--bg-input); padding:10px; border-radius:8px; display:flex; align-items:center; gap:10px; margin-top:10px;">
                        <input type="checkbox" id="smartWorking" style="width:20px; margin:0;">
                        <span style="font-size:0.9rem;">Smart Working in treno (-50% costo)</span>
                    </div>
                    <button class="btn-main" onclick="calculate()" style="width:100%">Calcola Risparmio</button>
                </div>

                <div id="resultsArea" class="card" style="display:none; text-align:center;">
                    <div id="verdictBox" class="verdict-box"></div>
                    
                    <div style="display:flex; justify-content:space-around; margin-bottom:20px;">
                        <div style="width:45%;"><h5>Citt√†</h5><canvas id="cityChart"></canvas></div>
                        <div style="width:45%;"><h5>Pendolare</h5><canvas id="homeChart"></canvas></div>
                    </div>
                    
                    <h5>Proiezione 5 Anni</h5>
                    <div style="height:150px;"><canvas id="lineChart"></canvas></div>
                    
                    <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
                        <button class="btn-main" style="background:#ef4444; width:auto;" onclick="makePDF()">
                            <i class="fa-solid fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn-main btn-wa" style="width:auto;" onclick="shareWa()">
                            <i class="fa-brands fa-whatsapp"></i> WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="ai" class="section-view">
            <div class="card" style="max-width:800px; margin:0 auto;">
                <h3 style="margin-top:0;"><i class="fa-solid fa-brain"></i> AI Geografica</h3>
                <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;">
                    Calcolo orari e prezzi tra <strong>tutte le province italiane</strong> basandomi sulla distanza reale.<br>
                    Esempio: "Treno Torino Padova" o "Treno Riccione Bologna".
                </p>

                <div class="chat-area" id="chatBox">
                    <div class="msg msg-bot">Ciao! Dimmi da dove parti e dove arrivi. üöÜ</div>
                </div>

                <video id="camera-preview" autoplay playsinline></video>
                <button id="snapBtn" class="btn-main" style="display:none; background:red; margin-bottom:10px; width:100%" onclick="takePhoto()">SCATTA</button>

                <div class="ai-tools">
                    <button class="tool-btn" onclick="startCamera()"><i class="fa-solid fa-camera"></i></button>
                    <label for="fileInput" class="tool-btn" style="margin:0; cursor:pointer;"><i class="fa-solid fa-image"></i></label>
                    <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
                    
                    <input type="text" id="aiInput" style="margin:0; border:none; background:transparent; flex:1;" placeholder="Scrivi qui..." onkeypress="if(event.key==='Enter') sendAi()">
                    <button class="tool-btn" style="color:var(--accent);" onclick="sendAi()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="community" class="section-view">
            <div class="card" style="max-width:800px; margin:0 auto;">
                <h3 style="margin-top:0;"><i class="fa-solid fa-comments"></i> Community Live</h3>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="text" id="postInput" placeholder="Messaggio..." style="margin:0;">
                    <button class="btn-main" style="width:auto; margin:0; padding:0 25px;" onclick="sendPost()">Invia</button>
                </div>
                <div id="feed"><div style="text-align:center; padding:20px; color:gray;">Caricamento...</div></div>
            </div>
        </div>

        <div id="about" class="section-view">
            <div class="card">
                <h2 style="color:var(--accent);">Chi Siamo?</h2>
                <div style="line-height:1.7;">
                   <strong>pendolareApp.it</strong> nasce per rispondere alla domanda che ogni lavoratore o studente si pone: 
                    <em>"Mi conviene fare il pendolare o trasferirmi?"</em>.<br><br>
                    Il nostro algoritmo unico analizza non solo i costi di biglietti e affitti, ma anche il <strong>valore del tuo tempo</strong> e lo stress del viaggio.
                    Grazie alla nostra <strong>AI</strong>, possiamo calcolare istantaneamente la fattibilit√† di qualsiasi tratta italiana.<br><br>
                    Unisciti alla nostra community per scambiare consigli reali con chi vive la tua stessa esperienza.
                </div>
            </div>
        </div>
    </div>

    <div id="pdf-template">
        <h1 style="color:#2563eb;">Report pendolareApp.it</h1>
        <div id="pdf-content"></div>
        <img id="pdf-img" style="width:100%; margin-top:30px;">
    </div>

<script>
    // ---------------------------------------------------------
    // 1. CONFIGURAZIONE FIREBASE (INSERISCI LE TUE CHIAVI)
    // ---------------------------------------------------------
    const firebaseConfig = {
       apiKey: "AIzaSyBp2f237xiMNFTRNbqAKu2Zmyw_wmppAJo",
  authDomain: "pendolareapp.firebaseapp.com",
  databaseURL: "https://pendolareapp-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "pendolareapp",
  storageBucket: "pendolareapp.firebasestorage.app",
  messagingSenderId: "520849252990",
  appId: "1:520849252990:web:e2553a4098e270349b6e2f",
  measurementId: "G-QG208D8JMJ"
    };

    let auth, db;
    try {
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.database();
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('user-display').innerText = user.email.split('@')[0];
                document.getElementById('user-display').style.display = 'block';
                listenForPosts();
            } else { document.getElementById('auth-overlay').style.display = 'flex'; }
        });
    } catch(e){console.error(e);}

    // AUTH
    function register(){const e=document.getElementById('email').value,p=document.getElementById('password').value;auth.createUserWithEmailAndPassword(e,p).catch(err=>document.getElementById('auth-error').innerText=err.message);}
    function login(){const e=document.getElementById('email').value,p=document.getElementById('password').value;auth.signInWithEmailAndPassword(e,p).catch(err=>document.getElementById('auth-error').innerText=err.message);}
    function logout(){auth.signOut();location.reload();}

    // UI
    function toggleMenu(){const m=document.getElementById('sideMenu'),o=document.querySelector('.menu-overlay');if(m.classList.contains('open')){m.classList.remove('open');o.style.display='none';}else{m.classList.add('open');o.style.display='block';}}
    function nav(id){document.querySelectorAll('.section-view').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');toggleMenu();}
    function toggleTheme(){const b=document.body,t=b.getAttribute('data-theme')==='light'?'dark':'light';b.setAttribute('data-theme',t);localStorage.setItem('theme',t);}

    // ---------------------------------------------------------
    // 2. DATABASE E CALCOLATORE
    // ---------------------------------------------------------
    const geoDB = {
        "agrigento":{x:55,y:5}, "alessandria":{x:25,y:80}, "ancona":{x:65,y:60}, "aosta":{x:10,y:90}, "arezzo":{x:50,y:60}, "ascoli piceno":{x:65,y:55}, "asti":{x:20,y:80}, "avellino":{x:65,y:35},
        "bari":{x:85,y:35}, "barletta":{x:80,y:38}, "belluno":{x:65,y:90}, "benevento":{x:65,y:38}, "bergamo":{x:35,y:85}, "biella":{x:25,y:85}, "bologna":{x:50,y:70}, "bolzano":{x:55,y:95}, "brescia":{x:40,y:85}, "brindisi":{x:90,y:30},
        "cagliari":{x:30,y:20}, "caltanissetta":{x:60,y:10}, "campobasso":{x:70,y:40}, "caserta":{x:60,y:35}, "catania":{x:70,y:10}, "catanzaro":{x:80,y:15}, "cesena":{x:56,y:68}, "chieti":{x:70,y:50}, "como":{x:30,y:88}, "cosenza":{x:78,y:20}, "cremona":{x:38,y:78}, "crotone":{x:85,y:15}, "cuneo":{x:15,y:75},
        "enna":{x:65,y:12}, "fermo":{x:66,y:54}, "ferrara":{x:55,y:72}, "firenze":{x:48,y:62}, "foggia":{x:75,y:40}, "forl√¨":{x:55,y:68}, "frosinone":{x:55,y:45},
        "genova":{x:30,y:75}, "gorizia":{x:75,y:85}, "grosseto":{x:45,y:50},
        "imperia":{x:20,y:70}, "isernia":{x:65,y:42},
        "la spezia":{x:35,y:70}, "l'aquila":{x:60,y:50}, "latina":{x:55,y:42}, "lecce":{x:95,y:25}, "lecco":{x:35,y:88}, "livorno":{x:40,y:60}, "lodi":{x:35,y:80}, "lucca":{x:42,y:65},
        "macerata":{x:65,y:58}, "mantova":{x:45,y:78}, "massa":{x:38,y:68}, "matera":{x:80,y:32}, "messina":{x:75,y:18}, "milano":{x:32,y:82}, "modena":{x:48,y:72}, "monza":{x:32,y:83},
        "napoli":{x:60,y:35}, "novara":{x:25,y:83}, "nuoro":{x:35,y:25},
        "oristano":{x:30,y:25},
        "padova":{x:60,y:80}, "palermo":{x:55,y:15}, "parma":{x:42,y:75}, "pavia":{x:30,y:78}, "perugia":{x:55,y:55}, "pesaro":{x:60,y:65}, "pescara":{x:70,y:52}, "piacenza":{x:38,y:78}, "pisa":{x:40,y:62}, "pistoia":{x:45,y:64}, "pordenone":{x:70,y:85}, "potenza":{x:75,y:30}, "prato":{x:47,y:63},
        "ragusa":{x:65,y:5}, "ravenna":{x:58,y:70}, "reggio calabria":{x:75,y:10}, "reggio emilia":{x:45,y:74}, "rieti":{x:58,y:50}, "rimini":{x:60,y:65}, "roma":{x:52,y:48}, "rovigo":{x:60,y:75},
        "salerno":{x:65,y:32}, "sassari":{x:30,y:30}, "savona":{x:25,y:72}, "siena":{x:50,y:55}, "siracusa":{x:70,y:8}, "sondrio":{x:40,y:92},
        "taranto":{x:85,y:30}, "teramo":{x:65,y:52}, "terni":{x:55,y:52}, "torino":{x:20,y:82}, "trapani":{x:50,y:12}, "trento":{x:50,y:90}, "treviso":{x:65,y:85}, "trieste":{x:78,y:85},
        "udine":{x:72,y:88},
        "varese":{x:28,y:88}, "venezia":{x:65,y:80}, "verbania":{x:25,y:90}, "vercelli":{x:25,y:82}, "verona":{x:50,y:82}, "vibo valentia":{x:78,y:18}, "vicenza":{x:58,y:82}, "viterbo":{x:52,y:52},
        // AGGIUNTE EXTRA
        "riccione": {x:60.2, y:64.8}, "gallipoli":{x:94,y:24}, "sanremo":{x:19,y:69}
    };

    const regions = {
        "Lombardia": ["Milano","Bergamo","Brescia","Como","Cremona","Lecco","Lodi","Mantova","Monza","Pavia","Sondrio","Varese"],
        "Lazio": ["Roma","Frosinone","Latina","Rieti","Viterbo"],
        "Campania": ["Napoli","Avellino","Benevento","Caserta","Salerno"],
        "Emilia-Romagna": ["Bologna","Ferrara","Forl√¨","Cesena","Modena","Parma","Piacenza","Ravenna","Reggio Emilia","Rimini"],
        "Piemonte": ["Torino","Alessandria","Asti","Biella","Cuneo","Novara","Verbania","Vercelli"],
        "Veneto": ["Venezia","Belluno","Padova","Rovigo","Treviso","Verona","Vicenza"],
        "Toscana": ["Firenze","Arezzo","Grosseto","Livorno","Lucca","Massa","Pisa","Pistoia","Prato","Siena"],
        "Puglia": ["Bari","Barletta","Brindisi","Foggia","Lecce","Taranto"],
        "Sicilia": ["Palermo","Agrigento","Caltanissetta","Catania","Enna","Messina","Ragusa","Siracusa","Trapani"],
        "Sardegna": ["Cagliari","Nuoro","Oristano","Sassari"],
        "Liguria": ["Genova","Imperia","La Spezia","Savona"],
        "Marche": ["Ancona","Ascoli Piceno","Fermo","Macerata","Pesaro"],
        "Abruzzo": ["L'Aquila","Chieti","Pescara","Teramo"],
        "Friuli V.G.": ["Trieste","Gorizia","Pordenone","Udine"],
        "Trentino": ["Trento","Bolzano"],
        "Umbria": ["Perugia","Terni"],
        "Basilicata": ["Potenza","Matera"],
        "Calabria": ["Catanzaro","Cosenza","Crotone","Reggio Calabria","Vibo Valentia"],
        "Molise": ["Campobasso","Isernia"],
        "Valle d'Aosta": ["Aosta"]
    };

    window.onload = () => {
        const h = document.getElementById('hubCity');
        for(let r in regions){ let g=document.createElement('optgroup'); g.label=r; regions[r].forEach(c=>{ let o=document.createElement('option'); o.value=c; o.text=c; g.appendChild(o); }); h.appendChild(g); }
    };

    function updateOrigins() {
        const h = document.getElementById('hubCity').value;
        const o = document.getElementById('originCity');
        o.innerHTML='<option value="">-- Seleziona --</option>'; o.disabled=false;
        for(let r in regions){ let g=document.createElement('optgroup'); g.label=r; regions[r].forEach(c=>{ if(c!==h){ let op=document.createElement('option'); op.value=c; op.text=c; g.appendChild(op); }}); o.appendChild(g); }
        document.getElementById('rentCity').value = 800;
    }

    function fillData() {
        const h = document.getElementById('hubCity').value.toLowerCase();
        const o = document.getElementById('originCity').value.toLowerCase();
        if(geoDB[h] && geoDB[o]) {
            const dist = Math.sqrt(Math.pow(geoDB[h].x - geoDB[o].x, 2) + Math.pow(geoDB[h].y - geoDB[o].y, 2));
            const cost = Math.max(30, Math.round(dist * 3)); 
            const time = Math.max(20, Math.round(dist * 2.5));
            document.getElementById('rentHome').value = 500;
            document.getElementById('transportCost').value = cost;
            document.getElementById('travelTime').value = time;
            document.getElementById('tVal').innerText = time;
        }
    }

    let c1, c2, c3;
    let globalData = {};

    function calculate() {
        const rC = Number(document.getElementById('rentCity').value);
        const rH = Number(document.getElementById('rentHome').value);
        const tr = Number(document.getElementById('transportCost').value);
        const min = Number(document.getElementById('travelTime').value);
        const val = Number(document.getElementById('hourlyValue').value);
        const isSmart = document.getElementById('smartWorking').checked;

        const timeCost = (min/60) * 20 * val * (isSmart ? 0.5 : 1);
        const totC = rC;
        const totH = rH + tr + timeCost;
        const diff = totC - totH;
        
        globalData = { rC, totC, rH, tr, timeCost, totH, diff };

        document.getElementById('resultsArea').style.display = 'block';
        const v = document.getElementById('verdictBox');
        if(diff > 0) { 
            v.className = "verdict-box win-green"; 
            v.innerHTML = `‚úÖ CONVIENE IL PENDOLARE (Risparmi ${Math.round(diff)}‚Ç¨/mese)`; 
        } else { 
            v.className = "verdict-box win-red"; 
            v.innerHTML = `üõë CONVIENE LA CITT√Ä (Risparmi ${Math.round(Math.abs(diff))}‚Ç¨/mese)`; 
        }

        // Configurazione Tooltip e Legenda con Percentuali
        const chartOptions = {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            let val = ctx.raw;
                            let tot = ctx.chart._metasets[ctx.datasetIndex].total;
                            return ctx.label + ": " + Math.round(val) + "‚Ç¨ (" + (val/tot*100).toFixed(1) + "%)";
                        }
                    }
                },
                legend: {
                    display: true, position: 'bottom',
                    labels: {
                        usePointStyle: true, padding: 20,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const meta = chart.getDatasetMeta(0);
                                    const style = meta.controller.getStyle(i);
                                    const value = data.datasets[0].data[i];
                                    const total = data.datasets[0].data.reduce((a,b)=>a+b,0);
                                    const percentage = (value/total*100).toFixed(1)+"%";
                                    return { text: `${label} (${percentage})`, fillStyle: style.backgroundColor, strokeStyle: style.borderColor, lineWidth: style.borderWidth, hidden: !chart.getDataVisibility(i), index: i };
                                });
                            } return [];
                        }
                    }
                }
            }
        };

        if(c1) c1.destroy(); if(c2) c2.destroy(); if(c3) c3.destroy();
        c1 = new Chart(document.getElementById('cityChart'), { type: 'doughnut', data: { labels: ['Affitto'], datasets: [{data: [totC], backgroundColor: ['#2563eb']}] }, options: chartOptions });
        c2 = new Chart(document.getElementById('homeChart'), { type: 'doughnut', data: { labels: ['Affitto', 'Viaggio', 'Tempo'], datasets: [{data: [rH, tr, timeCost], backgroundColor: ['#2563eb', '#10b981', '#ef4444']}] }, options: chartOptions });
        c3 = new Chart(document.getElementById('lineChart'), { type: 'line', data: { labels: ['1', '2', '3', '4', '5'], datasets: [{ label: 'Risparmio Cumulativo', data: [diff*12, diff*24, diff*36, diff*48, diff*60], borderColor: '#2563eb', fill: true, backgroundColor: 'rgba(37,99,235,0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
    }

    function makePDF() {
        const el = document.getElementById('pdf-template');
        document.getElementById('pdf-content').innerHTML = document.getElementById('verdictBox').innerHTML;
        document.getElementById('pdf-img').src = c3.toBase64Image();
        html2pdf().from(el).save('Report.pdf');
    }

    function shareWa() {
        if(!globalData || typeof globalData.diff === 'undefined') return alert("Calcola prima!");
        let msg = globalData.diff > 0 ? `‚úÖ Risparmio ${Math.round(globalData.diff)}‚Ç¨ facendo il pendolare!` : `üõë Meglio la citt√†, risparmierei ${Math.round(Math.abs(globalData.diff))}‚Ç¨!`;
        msg += " Calcola anche tu su pendolareApp.it";
        window.open("https://wa.me/?text=" + encodeURIComponent(msg));
    }

    // --- AI TRENI ---
    function sendAi() {
        const inp = document.getElementById('aiInput'); const txt = inp.value.trim().toLowerCase(); if(!txt) return;
        addMsg(inp.value, 'user'); inp.value = "";
        const box = document.getElementById('chatBox'); box.scrollTop = box.scrollHeight;
        setTimeout(() => processAi(txt), 800);
    }

    function processAi(txt) {
        const cleanTxt = txt.replace(/vorrei andare/g,"").replace(/biglietto/g,"").replace(/treno/g,"").replace(/ per /g," ").replace(/ a /g," ").replace(/ da /g," ");
        let found = [];
        for(let city in geoDB) { if(cleanTxt.includes(city)) found.push(city); }
        found = [...new Set(found)].sort((a,b)=>b.length-a.length);

        if(found.length >= 2) {
            const from = found[0]; const to = found[1];
            const dist = Math.sqrt(Math.pow(geoDB[from].x - geoDB[to].x, 2) + Math.pow(geoDB[from].y - geoDB[to].y, 2));
            
            let price, time, type;
            if(dist < 3) { price=(1.50+dist*0.5).toFixed(2); time=Math.round(5+dist*4)+" min"; type="Regionale"; }
            else if(dist < 20) { price=(4.00+dist*0.8).toFixed(2); time=Math.round(25+dist*2.5)+" min"; type="Regionale Veloce"; }
            else { price=(20.00+dist*1.6).toFixed(2); let mins=Math.round(50+dist*3.8); time=Math.floor(mins/60)+"h "+(mins%60)+"m"; type="Frecciarossa / Intercity"; }

            const d = new Date(); d.setDate(d.getDate()+1);
            const dateISO = d.toISOString().split('T')[0] + "T08:00:00";
            const link = `https://www.lefrecce.it/Channels.Website.WEB/#/search-results?departureStation=${encodeURIComponent(capitalize(from))}&arrivalStation=${encodeURIComponent(capitalize(to))}&journeyDate=${dateISO}&searchType=solutions&adults=1&childs=0&travelClass=2&pax=1`;

            const html = `
                Tratta: <strong>${capitalize(from)} ‚ûù ${capitalize(to)}</strong><br><br>
                ‚è±Ô∏è <strong>Tempo:</strong> ${time}<br>
                üí∂ <strong>Prezzo:</strong> ~${price}‚Ç¨<br>
                üöÜ <strong>Treno:</strong> ${type}<br><br>
                <a href="${link}" target="_blank" style="background:#c0392b; color:white; padding:10px 15px; border-radius:8px; text-decoration:none; font-weight:bold; display:inline-block;">
                    <i class="fa-solid fa-ticket"></i> Acquista su Trenitalia
                </a>
            `;
            addMsg(html, 'bot');
        } else { addMsg("Non ho capito le citt√†. Prova: 'Treno Forl√¨ Cesena' o 'Milano Roma'.", 'bot'); }
    }

    function addMsg(h, t) {
        const b = document.getElementById('chatBox');
        b.insertAdjacentHTML('beforeend', `<div class="msg msg-${t}">${h}</div>`);
        b.scrollTop = b.scrollHeight;
    }
    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    // CAMERA & COMMUNITY
    let vs; async function startCamera(){try{const v=document.getElementById('camera-preview');vs=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});v.srcObject=vs;v.style.display="block";document.getElementById('snapBtn').style.display="block";}catch(e){alert("Errore: "+e);}}
    function takePhoto(){const v=document.getElementById('camera-preview'),c=document.createElement('canvas');c.width=v.videoWidth;c.height=v.videoHeight;c.getContext('2d').drawImage(v,0,0);addMsg(`<img src="${c.toDataURL('image/png')}" class="msg-img">`,'user');vs.getTracks().forEach(t=>t.stop());v.style.display="none";document.getElementById('snapBtn').style.display="none";setTimeout(()=>addMsg("Foto analizzata.",'bot'),1000);}
    function handleFileUpload(i){const f=i.files[0];if(f){const r=new FileReader();r.onload=e=>{addMsg(`<img src="${e.target.result}" class="msg-img">`,'user');setTimeout(()=>addMsg("Analisi in corso...",'bot'),1000);};r.readAsDataURL(f);}}
    function sendPost(){const t=document.getElementById('postInput').value;if(!t)return;const u=auth.currentUser?auth.currentUser.email.split('@')[0]:"Anonimo";db.ref('posts').push({u:u,t:t,d:Date.now()});document.getElementById('postInput').value="";}
    function listenForPosts(){document.getElementById('feed').innerHTML="";db.ref('posts').limitToLast(15).on('child_added',s=>{const d=s.val(),date=new Date(d.d).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});document.getElementById('feed').insertAdjacentHTML('afterbegin',`<div class="post"><div class="post-header"><span class="post-user">${d.u}</span><span>${date}</span></div><div>${d.t}</div></div>`);});}
</script>
</body>
</html>